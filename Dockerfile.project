# =============================================================================
# Project Container Dockerfile
# =============================================================================
# Container for running Claude Agent SDK or OpenCode SDK on a single project.
# - Claude models: Uses Python-based agent_app.py
# - GLM-4.7 model: Uses TypeScript-based opencode_agent_app.ts
#
# Environment variables:
# - GIT_REMOTE_URL: Git repository URL to clone (required)
# - ANTHROPIC_API_KEY: API key for Claude
# - Other API keys as needed
#
# Usage:
#   docker build -f Dockerfile.project -t zerocoder-project .
#   docker run -d --name zerocoder-{project} -e GIT_REMOTE_URL=git@github.com:user/repo.git zerocoder-project

FROM python:3.11-slim-bookworm

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Disable beads daemon in containers (avoids stale lock file issues and sync conflicts)
ENV BD_NO_DAEMON=true
ENV BEADS_AUTO_START_DAEMON=false

# Install essentials and webapp development tools
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    ca-certificates \
    sudo \
    procps \
    jq \
    tree \
    zip \
    unzip \
    rsync \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js v22 (required for Vision MCP Server)
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install pnpm and yarn globally
RUN npm install -g pnpm yarn

# Create non-root user (required for Claude Code --dangerously-skip-permissions)
# Use a different UID to avoid conflicts with existing ubuntu user
# The coder user has passwordless sudo for installing packages
RUN useradd --uid 1001 -m coder \
    && echo "coder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install Claude Code CLI globally (required by Agent SDK)
RUN npm install -g @anthropic-ai/claude-code

# Install Claude Agent SDK
RUN pip install --no-cache-dir claude-agent-sdk

# Install beads CLI
RUN curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash \
    && mv /root/.local/bin/bd /usr/local/bin/bd 2>/dev/null || true

# =============================================================================
# OpenCode SDK Setup (for GLM-4.7 model)
# =============================================================================

# Install OpenCode CLI
RUN curl -fsSL https://opencode.ai/install | bash \
    && mv /root/.opencode/bin/opencode /usr/local/bin/opencode 2>/dev/null || true
ENV PATH="/root/.opencode/bin:${PATH}"

# Copy OpenCode configuration and agent definitions
COPY opencode_config/ /app/opencode_config/
COPY opencode_agent_app.ts /app/opencode_agent_app.ts
COPY package.opencode.json /app/package.json
COPY tsconfig.opencode.json /app/tsconfig.opencode.json

# Install OpenCode SDK dependencies and build TypeScript
WORKDIR /app
RUN npm install && npm run build

# Copy OpenCode config to the location where OpenCode CLI expects it
# This is needed for the server to find the Z.ai provider configuration
RUN mkdir -p /home/coder/.config/opencode \
    && cp /app/opencode_config/config.json /home/coder/.config/opencode/config.json \
    && chown -R coder:coder /home/coder/.config

# Reset working directory
WORKDIR /project

# =============================================================================
# Claude Agent SDK Setup (for Claude models)
# =============================================================================

# Copy agent application and container scripts
COPY agent_app.py /app/agent_app.py
COPY container_scripts/feature_status.py /app/feature_status.py
COPY container_scripts/beads_commands.py /app/beads_commands.py
COPY container_scripts/setup_repo.sh /app/setup_repo.sh
COPY container_scripts/cleanup_session.sh /app/cleanup_session.sh
RUN chmod +x /app/setup_repo.sh /app/cleanup_session.sh

# Configure git for container operations (for root, during build)
RUN git config --global user.email "agent@zerocoder.local" \
    && git config --global user.name "ZeroCoder Agent" \
    && git config --global init.defaultBranch main \
    && git config --global --add safe.directory /project

# Create directories for coder user
RUN mkdir -p /home/coder/.claude \
    && mkdir -p /home/coder/.ssh \
    && chmod 700 /home/coder/.ssh \
    && chown -R coder:coder /home/coder

# Configure git for coder user and set permissive umask
USER coder
RUN git config --global user.email "agent@zerocoder.local" \
    && git config --global user.name "ZeroCoder Agent" \
    && git config --global init.defaultBranch main \
    && git config --global --add safe.directory /project \
    && echo "umask 002" >> ~/.bashrc \
    && echo "umask 002" >> ~/.profile

# Switch back to root for runtime operations
USER root

# Working directory is the project directory (cloned at runtime)
WORKDIR /project

# Make /project writable by coder user for git clone
RUN chown coder:coder /project

# Create entrypoint script
COPY <<EOF /entrypoint.sh
#!/bin/bash
# Set TZ environment variable from /etc/timezone for Node.js
# (Node.js doesn't read /etc/localtime, it needs TZ env var)
if [ -f /etc/timezone ]; then
    export TZ=$(cat /etc/timezone)
fi

# Set fully permissive umask so ALL new files are world readable/writable
# This ensures both host user and container user can access files
# 000 = files 666, dirs 777
umask 000

# Update Claude Code to latest version at startup
echo "Updating Claude Code to latest version..."
npm update -g @anthropic-ai/claude-code 2>/dev/null || true

# Clean up stale beads daemon lock files (prevents stack overflow bug)
if [ -f "/project/.beads/daemon.lock" ]; then
    rm -f /project/.beads/daemon.lock
    echo "Removed stale beads daemon.lock"
fi

# Fix .beads directory permissions at startup (make world-writable)
# Don't chown - keep host ownership but make accessible to container
if [ -d "/project/.beads" ]; then
    chmod -R a+rwX /project/.beads 2>/dev/null || true
fi

# Fix prompts directory permissions at startup (make world-writable)
# This ensures host can update prompt templates
if [ -d "/project/prompts" ]; then
    chmod -R a+rwX /project/prompts 2>/dev/null || true
fi

# Create agent log file (world-writable so coder user can write to it)
# This file is tailed to show agent activity in docker logs
touch /var/log/agent.log
chmod 666 /var/log/agent.log
echo "[$(date -Iseconds)] Container started, waiting for agent..." >> /var/log/agent.log

# Set up SSH key for git operations (copy from temp mount with correct permissions)
if [ -f /tmp/ssh_key ]; then
    # Set up for coder user
    cp /tmp/ssh_key /home/coder/.ssh/id_ed25519
    chmod 600 /home/coder/.ssh/id_ed25519
    chown coder:coder /home/coder/.ssh/id_ed25519
    # Add GitHub to known_hosts (prevents "authenticity" prompts)
    ssh-keyscan github.com >> /home/coder/.ssh/known_hosts 2>/dev/null
    chmod 644 /home/coder/.ssh/known_hosts
    chown coder:coder /home/coder/.ssh/known_hosts
    # Also set up for root (for entrypoint git operations)
    mkdir -p /root/.ssh
    cp /tmp/ssh_key /root/.ssh/id_ed25519
    chmod 600 /root/.ssh/id_ed25519
    ssh-keyscan github.com >> /root/.ssh/known_hosts 2>/dev/null
    chmod 644 /root/.ssh/known_hosts
    echo "[$(date -Iseconds)] SSH key configured for git operations" >> /var/log/agent.log
fi

# Clone or pull repository from GIT_REMOTE_URL (as coder user who has SSH keys)
if [ -n "\$GIT_REMOTE_URL" ]; then
    if [ ! -d "/project/.git" ]; then
        echo "[$(date -Iseconds)] Cloning repository from \$GIT_REMOTE_URL..." >> /var/log/agent.log
        # Run as coder user who has SSH key configured
        if su - coder -c "git clone \$GIT_REMOTE_URL /project"; then
            chmod -R a+rwX /project 2>/dev/null || true
            echo "[$(date -Iseconds)] Repository cloned successfully" >> /var/log/agent.log
            # Set up beads git hooks for sync
            if [ -d "/project/.beads" ]; then
                su - coder -c "cd /project && bd sync" 2>/dev/null || true
                echo "[$(date -Iseconds)] Beads sync initialized" >> /var/log/agent.log
            fi
        else
            echo "[$(date -Iseconds)] ERROR: Failed to clone repository" >> /var/log/agent.log
        fi
    else
        echo "[$(date -Iseconds)] Repository already cloned, pulling latest..." >> /var/log/agent.log
        # Run git operations as coder user
        su - coder -c "cd /project && git fetch origin && git checkout main && git pull origin main"
        # Sync beads after pull
        if [ -d "/project/.beads" ]; then
            su - coder -c "cd /project && bd sync" 2>/dev/null || true
        fi
        echo "[$(date -Iseconds)] Repository updated successfully" >> /var/log/agent.log
    fi
fi

# Kill any running beads daemon (prevents sync conflicts)
if [ -f "/project/.beads/daemon.pid" ]; then
    DAEMON_PID=\$(cat /project/.beads/daemon.pid 2>/dev/null)
    if [ -n "\$DAEMON_PID" ] && kill -0 "\$DAEMON_PID" 2>/dev/null; then
        echo "[$(date -Iseconds)] Stopping beads daemon (PID: \$DAEMON_PID)..." >> /var/log/agent.log
        kill "\$DAEMON_PID" 2>/dev/null || true
        sleep 1
    fi
    rm -f /project/.beads/daemon.pid /project/.beads/daemon.lock
fi

# Run repository setup script (initializes beads based on CONTAINER_TYPE)
if [ -f "/app/setup_repo.sh" ]; then
    echo "[$(date -Iseconds)] Running repository setup (type: \${CONTAINER_TYPE:-coding})..." >> /var/log/agent.log
    su - coder -c "cd /project && CONTAINER_TYPE=\${CONTAINER_TYPE:-coding} BD_NO_DAEMON=true /app/setup_repo.sh"
fi

# Keep container running by tailing the agent log
# Agent processes will write to this file, making output visible in docker logs
exec tail -f /var/log/agent.log
EOF
RUN chmod +x /entrypoint.sh

# Default command - entrypoint keeps container alive
CMD ["/entrypoint.sh"]
