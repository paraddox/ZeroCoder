# =============================================================================
# Project Container Dockerfile
# =============================================================================
# Container for running Claude Agent SDK or OpenCode SDK on a single project.
# - Claude models: Uses Python-based agent_app.py
# - GLM-4.7 model: Uses TypeScript-based opencode_agent_app.ts
#
# Usage:
#   docker build -f Dockerfile.project -t zerocoder-project .
#   docker run -d --name zerocoder-{project} -v /path/to/project:/project zerocoder-project

FROM python:3.11-slim-bookworm

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Disable beads daemon in containers (avoids stale lock file issues)
ENV BD_NO_DAEMON=true

# Install essentials (including procps for pgrep health checks)
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    ca-certificates \
    sudo \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js v22 (required for Vision MCP Server)
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user (required for Claude Code --dangerously-skip-permissions)
# Use a different UID to avoid conflicts with existing ubuntu user
# The coder user has passwordless sudo for installing packages
RUN useradd --uid 1001 -m coder \
    && echo "coder ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install Claude Code CLI globally (required by Agent SDK)
RUN npm install -g @anthropic-ai/claude-code

# Install Claude Agent SDK
RUN pip install --no-cache-dir claude-agent-sdk

# Install beads CLI
RUN curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash \
    && mv /root/.local/bin/bd /usr/local/bin/bd 2>/dev/null || true

# =============================================================================
# OpenCode SDK Setup (for GLM-4.7 model)
# =============================================================================

# Install OpenCode CLI
RUN curl -fsSL https://opencode.ai/install | bash \
    && mv /root/.opencode/bin/opencode /usr/local/bin/opencode 2>/dev/null || true
ENV PATH="/root/.opencode/bin:${PATH}"

# Copy OpenCode configuration and agent definitions
COPY opencode_config/ /app/opencode_config/
COPY opencode_agent_app.ts /app/opencode_agent_app.ts
COPY package.opencode.json /app/package.json
COPY tsconfig.opencode.json /app/tsconfig.opencode.json

# Install OpenCode SDK dependencies and build TypeScript
WORKDIR /app
RUN npm install && npm run build

# Copy OpenCode config to the location where OpenCode CLI expects it
# This is needed for the server to find the Z.ai provider configuration
RUN mkdir -p /home/coder/.config/opencode \
    && cp /app/opencode_config/config.json /home/coder/.config/opencode/config.json \
    && chown -R coder:coder /home/coder/.config

# Reset working directory
WORKDIR /project

# =============================================================================
# Claude Agent SDK Setup (for Claude models)
# =============================================================================

# Copy agent application and container scripts
COPY agent_app.py /app/agent_app.py
COPY container_scripts/feature_status.py /app/feature_status.py
COPY container_scripts/beads_commands.py /app/beads_commands.py

# Configure git for beads operations (for root, during build)
RUN git config --global user.email "docker@zerocoder.local" \
    && git config --global user.name "ZeroCoder Docker" \
    && git config --global init.defaultBranch main

# Create directories for coder user
RUN mkdir -p /home/coder/.claude \
    && chown -R coder:coder /home/coder

# Configure git for coder user and set permissive umask
USER coder
RUN git config --global user.email "docker@zerocoder.local" \
    && git config --global user.name "ZeroCoder Docker" \
    && git config --global init.defaultBranch main \
    && echo "umask 002" >> ~/.bashrc \
    && echo "umask 002" >> ~/.profile

# Switch back to root for runtime volume mounting
USER root

# Working directory is the mounted project
WORKDIR /project

# Create entrypoint script
COPY <<EOF /entrypoint.sh
#!/bin/bash
# Set fully permissive umask so ALL new files are world readable/writable
# This ensures both host user and container user can access files
# 000 = files 666, dirs 777
umask 000

# Update Claude Code to latest version at startup
echo "Updating Claude Code to latest version..."
npm update -g @anthropic-ai/claude-code 2>/dev/null || true

# Clean up stale beads daemon lock files (prevents stack overflow bug)
if [ -f "/project/.beads/daemon.lock" ]; then
    rm -f /project/.beads/daemon.lock
    echo "Removed stale beads daemon.lock"
fi

# Fix .beads directory permissions at startup (make world-writable)
# Don't chown - keep host ownership but make accessible to container
if [ -d "/project/.beads" ]; then
    chmod -R a+rwX /project/.beads 2>/dev/null || true
fi

# Fix prompts directory permissions at startup (make world-writable)
# This ensures host can update prompt templates
if [ -d "/project/prompts" ]; then
    chmod -R a+rwX /project/prompts 2>/dev/null || true
fi

# Create agent log file (world-writable so coder user can write to it)
# This file is tailed to show agent activity in docker logs
touch /var/log/agent.log
chmod 666 /var/log/agent.log
echo "[$(date -Iseconds)] Container started, waiting for agent..." >> /var/log/agent.log

# Keep container running by tailing the agent log
# Agent processes will write to this file, making output visible in docker logs
exec tail -f /var/log/agent.log
EOF
RUN chmod +x /entrypoint.sh

# Default command - entrypoint keeps container alive
CMD ["/entrypoint.sh"]
